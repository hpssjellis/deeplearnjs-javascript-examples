<script src="https://unpkg.com/deeplearn@0.5.1/dist/deeplearn.js"> </script> 

<script>
const EPSILON = dl.scalar(1e-7);
const HIDDEN_UNITS = 10;
const one = dl.scalar(1);

const input = [[0, 0], [0, 1], [1, 0], [1, 1]];
const target = [[0], [1], [1], [0]];

const inputTensor: dl.Tensor2D = dl.tensor2d(input, [4, 2]);

const targetTensor: dl.Tensor2D = dl.tensor2d(target, [4, 1]);

const fullyConnectedWeights1 =
    dl.variable(initializeWeights([2, HIDDEN_UNITS], 2) );

const fullyConnectedBias1 = dl.variable(dl.scalar(0));

const fullyConnectedWeights2 = dl.variable(
    initializeWeights([HIDDEN_UNITS, 1], HIDDEN_UNITS));

const fullyConnectedBias2 = dl.variable(dl.scalar(0));

const optimizer = new dl.SGDOptimizer(0.1);

const getRandomIntegerInRange = (min, max) => {
  return Math.floor(Math.random() * (max - min + 1)) + min;
};

function initializeWeights(shape, prevLayerSize) {
  return dl.randomNormal(shape).mul(dl.scalar(Math.sqrt(2.0 / prevLayerSize)));
}

function calculateCost(y, output){
  return dl.add(
               y.mul(output.add(EPSILON).log()),
               one.sub(y).mul(one.sub(output).add(EPSILON).log())).sum().neg();
}

function model(xs){
  const hiddenLayer = dl.tidy(() => {
    return xs.matMul(fullyConnectedWeights1).add(fullyConnectedBias1).relu() 
  });

  return hiddenLayer.matMul(fullyConnectedWeights2)
             .add(fullyConnectedBias2)
             .sigmoid();
}

// Train the model.
async function train(iterations: number) {
  const returnCost = true;
  let cost;

  for (let i = 0; i < iterations; i++) {
    cost = optimizer.minimize(() => {
      return calculateCost(targetTensor, model(inputTensor));
    }, returnCost);

    if (i % 10 === 0) {
      console.log(`loss[${i}]: ${cost.getValues()}`);
    }

    await dl.nextFrame();
  }

  return cost.dataSync();
}

const learnXOR = async () => {
  const iterations = getRandomIntegerInRange(800, 1000);
  const timeStart = performance.now();
  const result = [];

  const loss = await train(iterations);

  /**
   * Test the model
   */
  for (let i = 0; i < 4; i += 1) {
    const inputData = dl.tensor2d([input[i]], [1, 2]);
    const expectedOutput = dl.tensor1d(target[i]);

    const val = model(inputData);

    result.push({
      input: await inputData.data(),
      expected: await expectedOutput.data(),
      output: await val.data()
    });
  }

  const timeEnd: number = performance.now();
  const time = timeEnd - timeStart;

  return {iterations, loss, time, result};
};


</script>




<input type=button value=run onclick="{
                                      
  document.getElementById('myDiv01').innerHTML = 'xOR [0,0] = '+myNetwork.activate([0,0])+'<br>'
  document.getElementById('myDiv01').innerHTML += 'xOR [0,1] = '+myNetwork.activate([0,1])+'<br>'
  document.getElementById('myDiv01').innerHTML += 'xOR [1,0] = '+myNetwork.activate([1,0])+'<br>'
  document.getElementById('myDiv01').innerHTML += 'xOR [1,1] = '+myNetwork.activate([1,1])+'<br>'
}">
<div id="myDiv01">...</div>




